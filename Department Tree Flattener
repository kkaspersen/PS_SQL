WITH T AS ( 
 SELECT TN.TREE_NODE 
 , TN.PARENT_NODE_NAME 
 , TN.TREE_NODE_NUM 
 , TN.PARENT_NODE_NUM 
 , TN.TREE_LEVEL_NUM 
 , DD.DESCR 
 , DD.DESCRSHORT 
 , DD.EFF_STATUS 
  FROM PSTREENODE TN INNER JOIN PS_DEPT_TBL DD ON TN.TREE_NODE = 
DD.DEPTID 
 WHERE TN.TREE_NAME = 'DEPT_SECURITY' 
   AND DD.EFFDT = ( 
 SELECT MAX(DD1.EFFDT) 
  FROM PS_DEPT_TBL DD1 
 WHERE DD1.DEPTID = DD.DEPTID 
   AND DD1.EFFDT <= SYSDATE) 
   AND TN.EFFDT = ( 
 SELECT MAX(TD.EFFDT) 
  FROM PSTREEDEFN TD 
 WHERE TD.TREE_NAME = 'DEPT_SECURITY' 
   AND TD.EFFDT <= SYSDATE)), H AS ( 
 SELECT CONNECT_BY_ROOT(T.TREE_NODE) DEPTID 
 , CONNECT_BY_ROOT(T.DESCR) DEPTNAME 
  , CONNECT_BY_ROOT(T.DESCRSHORT) DEPTSHORT 
 , CONNECT_BY_ROOT(T.EFF_STATUS) EFF_STATUS 
 ,T.TREE_LEVEL_NUM 
 , T.TREE_NODE 
 , T.DESCR 
 , T.DESCRSHORT 
  FROM T START WITH T.TREE_NODE IN ( 
 SELECT DEPTID 
  FROM PS_JOB 
  UNION 
 SELECT PD.DEPTID 
  FROM PS_POSITION_DATA PD 
  UNION 
 SELECT PPC.DEPTID 
  FROM PS_KC_PDQ_POS_CHG PPC 
  UNION 
 SELECT PPN.DEPTID 
  FROM PS_KC_PDQ_POS_NEW PPN 
  UNION 
 SELECT KSRD.KC_REQUESTING_DEPT 
  FROM PS_KC_SDP_REQ_DATA KSRD 
  UNION 
 SELECT KSRP.KC_CURR_DEPTID 
  FROM PS_KC_SDP_REQ_PAY KSRP 
  UNION 
 SELECT KSRP.KC_SDP_DEPTID 
  FROM PS_KC_SDP_REQ_PAY KSRP 
  UNION 
 SELECT DEPTID 
  FROM PS_DEPT_TBL 
 WHERE EFFDT > SYSDATE - 90 
   AND EFF_STATUS = 'A' ) CONNECT BY T.TREE_NODE_NUM = PRIOR 
T.PARENT_NODE_NUM) 
 SELECT MAX(CASE WHEN H.TREE_LEVEL_NUM = 2 THEN TREE_NODE ELSE ' ' 
END) KC_DEPT_NBR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 2 THEN DESCR ELSE ' ' END) 
KC_DEPT_DESCR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 2 THEN DESCRSHORT ELSE ' ' END) 
KC_DEPT_SHORT 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 3 THEN TREE_NODE ELSE ' ' END) 
KC_DIV_NBR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 3 THEN DESCR ELSE ' ' END) 
KC_DIV_DESCR
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 3 THEN DESCRSHORT ELSE ' ' END) 
KC_DIV_SHORT 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 4 THEN TREE_NODE ELSE ' ' END) 
KC_SECTION_NBR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 4 THEN DESCR ELSE ' ' END) 
KC_SECTION_DESCR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 4 THEN DESCRSHORT ELSE ' ' END) 
KC_SECTION_SHORT 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 5 THEN TREE_NODE ELSE ' ' END) 
KC_UNIT_NBR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 5 THEN DESCR ELSE ' ' END) 
KC_UNIT_DESCR 
 , MAX(CASE WHEN H.TREE_LEVEL_NUM = 5 THEN DESCRSHORT ELSE ' ' END) 
KC_UNIT_SHORT 
 , H.DEPTID 
 , H.DEPTNAME 
 , H.DEPTSHORT
 , H.EFF_STATUS 
  FROM H 
  GROUP BY H.DEPTID 
  , H.DEPTNAME 
  , H.DEPTSHORT
  , H.EFF_STATUS
